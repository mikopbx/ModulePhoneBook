"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2024 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global Config, globalTranslate, UserMessage, PbxApi, mergingCheckWorker */
var ModulePhoneBookImport = {
  /**
   * jQuery object for the progress bar.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * jQuery object for the import button
   * @type {jQuery}
   */
  $importButton: $('#import-from-excel-button'),

  /**
   * jQuery object for the progress bar label.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * jQuery object for the file input field.
   * @type {jQuery}
   */
  $fileInput: $('#file'),
  importFromExcelAJAXUrl: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModulePhoneBook/import-from-excel"),
  initialize: function initialize() {
    // Trigger file input click when clicking on text input or button
    $('input:text, .select-file-for-upload', '.ui.action.input').on('click', function (e) {
      $('input:file', $(e.target).parents()).click();
    }); // Update text input value when selecting a file

    $('input:file', '.ui.action.input').on('change', function (e) {
      if (e.target.files[0] !== undefined) {
        var filename = e.target.files[0].name;
        $('input:text', $(e.target).parent()).val(filename);
        ModulePhoneBookImport.$importButton.removeClass('disabled');
      }
    }); // Инициализируем нажатие на кнопку

    ModulePhoneBookImport.$importButton.on('click', ModulePhoneBookImport.uploadExcelFile);
  },

  /**
   * Функция импорта файла через POST-запрос с использованием Semantic UI API и FormData
   */
  uploadExcelFile: function uploadExcelFile() {
    var file = $('input:file')[0].files[0]; // Проверяем, выбран ли файл

    if (!file) {
      UserMessage.showError(globalTranslate.module_phnbk_ImportFromExcelLabel);
      return;
    }

    PbxApi.FilesUploadFile(file, ModulePhoneBookImport.cbResumableUploadFile);
  },

  /**
   * Callback function for resumable file upload.
   * @param {string} action - The action of the upload.
   * @param {object} params - Additional parameters for the upload.
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        ModulePhoneBookImport.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        ModulePhoneBookImport.$importButton.addClass('loading');
        ModulePhoneBookImport.$progressBar.show();
        ModulePhoneBookImport.$progressBarLabel.text(globalTranslate.module_phnbk_UploadInProgress);
        break;

      case 'progress':
        ModulePhoneBookImport.$progressBar.progress({
          percent: parseInt(params.percent, 10)
        });
        break;

      case 'error':
        ModulePhoneBookImport.$importButton.removeClass('loading');
        ModulePhoneBookImport.$progressBarLabel.text(globalTranslate.module_phnbk_UploadError);
        UserMessage.showMultiString(globalTranslate.module_phnbk_UploadError);
        break;

      default:
    }
  },

  /**
   * Checks the status of the file merging process.
   * @param {string} response - The response from the /pbxcore/api/upload/status function.
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.module_phnbk_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.module_phnbk_UploadError));
      return;
    }

    var fileID = json.data.upload_id;
    var filePath = json.data.filename; // Wait until system glued all parts of file

    mergingCheckWorker.initialize(fileID, filePath);
  },
  importExcelFile: function importExcelFile(uploadedFilePath) {
    ModulePhoneBookImport.$progressBarLabel.text(globalTranslate.module_phnbk_RecognitionOnProgress);
    $.api({
      url: ModulePhoneBookImport.importFromExcelAJAXUrl,
      method: 'POST',
      on: 'now',
      data: {
        uploadedFilePath: uploadedFilePath
      },
      beforeXHR: function beforeXHR(xhr) {
        xhr.setRequestHeader('X-Processor-Timeout', '600');
      },
      successTest: PbxApi.successTest,
      onSuccess: function onSuccess(response) {
        ModulePhoneBookImport.$progressBarLabel.text(globalTranslate.module_phnbk_RecognitionFinished);
        ModulePhoneBookImport.$importButton.removeClass('loading');
        window.location.reload(); // Обновляем страницу после успешного импорта
      },
      onFailure: function onFailure(response) {
        ModulePhoneBookImport.$importButton.removeClass('loading');
        UserMessage.showMultiString(response.messages || globalTranslate.module_phnbk_GeneraLFileUploadError);
      }
    });
  }
};
$(document).ready(function () {
  ModulePhoneBookImport.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtcGhvbmVib29rLWltcG9ydC5qcyJdLCJuYW1lcyI6WyJNb2R1bGVQaG9uZUJvb2tJbXBvcnQiLCIkcHJvZ3Jlc3NCYXIiLCIkIiwiJGltcG9ydEJ1dHRvbiIsIiRwcm9ncmVzc0JhckxhYmVsIiwiJGZpbGVJbnB1dCIsImltcG9ydEZyb21FeGNlbEFKQVhVcmwiLCJDb25maWciLCJwYnhVcmwiLCJpbml0aWFsaXplIiwib24iLCJlIiwidGFyZ2V0IiwicGFyZW50cyIsImNsaWNrIiwiZmlsZXMiLCJ1bmRlZmluZWQiLCJmaWxlbmFtZSIsIm5hbWUiLCJwYXJlbnQiLCJ2YWwiLCJyZW1vdmVDbGFzcyIsInVwbG9hZEV4Y2VsRmlsZSIsImZpbGUiLCJVc2VyTWVzc2FnZSIsInNob3dFcnJvciIsImdsb2JhbFRyYW5zbGF0ZSIsIm1vZHVsZV9waG5ia19JbXBvcnRGcm9tRXhjZWxMYWJlbCIsIlBieEFwaSIsIkZpbGVzVXBsb2FkRmlsZSIsImNiUmVzdW1hYmxlVXBsb2FkRmlsZSIsImFjdGlvbiIsInBhcmFtcyIsImNoZWNrU3RhdHVzRmlsZU1lcmdpbmciLCJyZXNwb25zZSIsImFkZENsYXNzIiwic2hvdyIsInRleHQiLCJtb2R1bGVfcGhuYmtfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwibW9kdWxlX3BobmJrX1VwbG9hZEVycm9yIiwic2hvd011bHRpU3RyaW5nIiwidHJ5UGFyc2VKU09OIiwianNvbiIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJmaWxlSUQiLCJ1cGxvYWRfaWQiLCJmaWxlUGF0aCIsIm1lcmdpbmdDaGVja1dvcmtlciIsImltcG9ydEV4Y2VsRmlsZSIsInVwbG9hZGVkRmlsZVBhdGgiLCJtb2R1bGVfcGhuYmtfUmVjb2duaXRpb25PblByb2dyZXNzIiwiYXBpIiwidXJsIiwibWV0aG9kIiwiYmVmb3JlWEhSIiwieGhyIiwic2V0UmVxdWVzdEhlYWRlciIsInN1Y2Nlc3NUZXN0Iiwib25TdWNjZXNzIiwibW9kdWxlX3BobmJrX1JlY29nbml0aW9uRmluaXNoZWQiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInJlbG9hZCIsIm9uRmFpbHVyZSIsIm1lc3NhZ2VzIiwibW9kdWxlX3BobmJrX0dlbmVyYUxGaWxlVXBsb2FkRXJyb3IiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0E7QUFFQSxJQUFNQSxxQkFBcUIsR0FBRztBQUMxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUVDLENBQUMsQ0FBQyxzQkFBRCxDQUxXOztBQU8xQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUVELENBQUMsQ0FBQywyQkFBRCxDQVhVOztBQWExQjtBQUNKO0FBQ0E7QUFDQTtBQUNJRSxFQUFBQSxpQkFBaUIsRUFBRUYsQ0FBQyxDQUFDLDRCQUFELENBakJNOztBQW1CMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUcsRUFBQUEsVUFBVSxFQUFFSCxDQUFDLENBQUMsT0FBRCxDQXZCYTtBQXlCMUJJLEVBQUFBLHNCQUFzQixZQUFLQyxNQUFNLENBQUNDLE1BQVosMkRBekJJO0FBMkIxQkMsRUFBQUEsVUEzQjBCLHdCQTJCYjtBQUVUO0FBQ0FQLElBQUFBLENBQUMsQ0FBQyxxQ0FBRCxFQUF3QyxrQkFBeEMsQ0FBRCxDQUE2RFEsRUFBN0QsQ0FBZ0UsT0FBaEUsRUFBeUUsVUFBQ0MsQ0FBRCxFQUFPO0FBQzVFVCxNQUFBQSxDQUFDLENBQUMsWUFBRCxFQUFlQSxDQUFDLENBQUNTLENBQUMsQ0FBQ0MsTUFBSCxDQUFELENBQVlDLE9BQVosRUFBZixDQUFELENBQXVDQyxLQUF2QztBQUNILEtBRkQsRUFIUyxDQU9UOztBQUNBWixJQUFBQSxDQUFDLENBQUMsWUFBRCxFQUFlLGtCQUFmLENBQUQsQ0FB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O0FBQ0FoRSxRQUFBQSxxQkFBcUIsQ0FBQ0csYUFBdEIsQ0FBb0NrQixXQUFwQyxDQUFnRCxTQUFoRDtBQUNBNEMsUUFBQUEsTUFBTSxDQUFDQyxRQUFQLENBQWdCQyxNQUFoQixHQUhnQixDQUdVO0FBQzdCLE9BYkM7QUFjRkMsTUFBQUEsU0FkRSxxQkFjUWxDLFFBZFIsRUFja0I7QUFDaEJsQyxRQUFBQSxxQkFBcUIsQ0FBQ0csYUFBdEIsQ0FBb0NrQixXQUFwQyxDQUFnRCxTQUFoRDtBQUNBRyxRQUFBQSxXQUFXLENBQUNtQixlQUFaLENBQTRCVCxRQUFRLENBQUNtQyxRQUFULElBQXFCM0MsZUFBZSxDQUFDNEMsbUNBQWpFO0FBQ0g7QUFqQkMsS0FBTjtBQW1CSDtBQWpJeUIsQ0FBOUI7QUFvSUFwRSxDQUFDLENBQUNxRSxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCeEUsRUFBQUEscUJBQXFCLENBQUNTLFVBQXRCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDI0IEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG4vKiBnbG9iYWwgQ29uZmlnLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlLCBQYnhBcGksIG1lcmdpbmdDaGVja1dvcmtlciAqL1xuXG5jb25zdCBNb2R1bGVQaG9uZUJvb2tJbXBvcnQgPSB7XG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIHByb2dyZXNzIGJhci5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBpbXBvcnQgYnV0dG9uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkaW1wb3J0QnV0dG9uOiAkKCcjaW1wb3J0LWZyb20tZXhjZWwtYnV0dG9uJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgcHJvZ3Jlc3MgYmFyIGxhYmVsLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWxhYmVsJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZmlsZSBpbnB1dCBmaWVsZC5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmaWxlSW5wdXQ6ICQoJyNmaWxlJyksXG4gICAgXG4gICAgaW1wb3J0RnJvbUV4Y2VsQUpBWFVybDogYCR7Q29uZmlnLnBieFVybH0vcGJ4Y29yZS9hcGkvbW9kdWxlcy9Nb2R1bGVQaG9uZUJvb2svaW1wb3J0LWZyb20tZXhjZWxgLFxuXG4gICAgaW5pdGlhbGl6ZSgpIHtcblxuICAgICAgICAvLyBUcmlnZ2VyIGZpbGUgaW5wdXQgY2xpY2sgd2hlbiBjbGlja2luZyBvbiB0ZXh0IGlucHV0IG9yIGJ1dHRvblxuICAgICAgICAkKCdpbnB1dDp0ZXh0LCAuc2VsZWN0LWZpbGUtZm9yLXVwbG9hZCcsICcudWkuYWN0aW9uLmlucHV0Jykub24oJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgICQoJ2lucHV0OmZpbGUnLCAkKGUudGFyZ2V0KS5wYXJlbnRzKCkpLmNsaWNrKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFVwZGF0ZSB0ZXh0IGlucHV0IHZhbHVlIHdoZW4gc2VsZWN0aW5nIGEgZmlsZVxuICAgICAgICAkKCdpbnB1dDpmaWxlJywgJy51aS5hY3Rpb24uaW5wdXQnKS5vbignY2hhbmdlJywgKGUpID0+IHtcbiAgICAgICAgICAgIGlmIChlLnRhcmdldC5maWxlc1swXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBlLnRhcmdldC5maWxlc1swXS5uYW1lO1xuICAgICAgICAgICAgICAgICQoJ2lucHV0OnRleHQnLCAkKGUudGFyZ2V0KS5wYXJlbnQoKSkudmFsKGZpbGVuYW1lKTtcbiAgICAgICAgICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJGltcG9ydEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8g0JjQvdC40YbQuNCw0LvQuNC30LjRgNGD0LXQvCDQvdCw0LbQsNGC0LjQtSDQvdCwINC60L3QvtC/0LrRg1xuICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJGltcG9ydEJ1dHRvbi5vbignY2xpY2snLCBNb2R1bGVQaG9uZUJvb2tJbXBvcnQudXBsb2FkRXhjZWxGaWxlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICog0KTRg9C90LrRhtC40Y8g0LjQvNC/0L7RgNGC0LAg0YTQsNC50LvQsCDRh9C10YDQtdC3IFBPU1Qt0LfQsNC/0YDQvtGBINGBINC40YHQv9C+0LvRjNC30L7QstCw0L3QuNC10LwgU2VtYW50aWMgVUkgQVBJINC4IEZvcm1EYXRhXG4gICAgICovXG4gICAgdXBsb2FkRXhjZWxGaWxlKCkge1xuICAgICAgICBjb25zdCBmaWxlID0gJCgnaW5wdXQ6ZmlsZScpWzBdLmZpbGVzWzBdO1xuXG4gICAgICAgIC8vINCf0YDQvtCy0LXRgNGP0LXQvCwg0LLRi9Cx0YDQsNC9INC70Lgg0YTQsNC50LtcbiAgICAgICAgaWYgKCFmaWxlKSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93RXJyb3IoZ2xvYmFsVHJhbnNsYXRlLm1vZHVsZV9waG5ia19JbXBvcnRGcm9tRXhjZWxMYWJlbCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBQYnhBcGkuRmlsZXNVcGxvYWRGaWxlKGZpbGUsIE1vZHVsZVBob25lQm9va0ltcG9ydC5jYlJlc3VtYWJsZVVwbG9hZEZpbGUpO1xuICAgIH0sXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHJlc3VtYWJsZSBmaWxlIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYWN0aW9uIC0gVGhlIGFjdGlvbiBvZiB0aGUgdXBsb2FkLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgZm9yIHRoZSB1cGxvYWQuXG4gICAgICovXG4gICAgY2JSZXN1bWFibGVVcGxvYWRGaWxlKGFjdGlvbiwgcGFyYW1zKSB7XG4gICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdmaWxlU3VjY2Vzcyc6XG4gICAgICAgICAgICAgICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3VwbG9hZFN0YXJ0JzpcbiAgICAgICAgICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJGltcG9ydEJ1dHRvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIE1vZHVsZVBob25lQm9va0ltcG9ydC4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuICAgICAgICAgICAgICAgIE1vZHVsZVBob25lQm9va0ltcG9ydC4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5tb2R1bGVfcGhuYmtfVXBsb2FkSW5Qcm9ncmVzcyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdwcm9ncmVzcyc6XG4gICAgICAgICAgICAgICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LiRwcm9ncmVzc0Jhci5wcm9ncmVzcyh7XG4gICAgICAgICAgICAgICAgICAgIHBlcmNlbnQ6IHBhcnNlSW50KHBhcmFtcy5wZXJjZW50LCAxMCksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdlcnJvcic6XG4gICAgICAgICAgICAgICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LiRpbXBvcnRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3BobmJrX1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoZ2xvYmFsVHJhbnNsYXRlLm1vZHVsZV9waG5ia19VcGxvYWRFcnJvcik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICB9XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiBDaGVja3MgdGhlIHN0YXR1cyBvZiB0aGUgZmlsZSBtZXJnaW5nIHByb2Nlc3MuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gdGhlIC9wYnhjb3JlL2FwaS91cGxvYWQvc3RhdHVzIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIGNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgUGJ4QXBpLnRyeVBhcnNlSlNPTihyZXNwb25zZSkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLm1vZHVsZV9waG5ia19VcGxvYWRFcnJvcn1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIGlmIChqc29uID09PSB1bmRlZmluZWQgfHwganNvbi5kYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhgJHtnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3BobmJrX1VwbG9hZEVycm9yfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbGVJRCA9IGpzb24uZGF0YS51cGxvYWRfaWQ7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0ganNvbi5kYXRhLmZpbGVuYW1lO1xuICAgICAgICAvLyBXYWl0IHVudGlsIHN5c3RlbSBnbHVlZCBhbGwgcGFydHMgb2YgZmlsZVxuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKTtcbiAgICB9LFxuICAgIGltcG9ydEV4Y2VsRmlsZSh1cGxvYWRlZEZpbGVQYXRoKXtcbiAgICAgICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLm1vZHVsZV9waG5ia19SZWNvZ25pdGlvbk9uUHJvZ3Jlc3MpO1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IE1vZHVsZVBob25lQm9va0ltcG9ydC5pbXBvcnRGcm9tRXhjZWxBSkFYVXJsLFxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBkYXRhOiB7dXBsb2FkZWRGaWxlUGF0aDp1cGxvYWRlZEZpbGVQYXRofSxcbiAgICAgICAgICAgIGJlZm9yZVhIUih4aHIpIHtcbiAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1Qcm9jZXNzb3ItVGltZW91dCcsICc2MDAnKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdWNjZXNzVGVzdDogUGJ4QXBpLnN1Y2Nlc3NUZXN0LFxuICAgICAgICAgICAgb25TdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLm1vZHVsZV9waG5ia19SZWNvZ25pdGlvbkZpbmlzaGVkKTtcbiAgICAgICAgICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJGltcG9ydEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTsgLy8g0J7QsdC90L7QstC70Y/QtdC8INGB0YLRgNCw0L3QuNGG0YMg0L/QvtGB0LvQtSDRg9GB0L/QtdGI0L3QvtCz0L4g0LjQvNC/0L7RgNGC0LBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbkZhaWx1cmUocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBNb2R1bGVQaG9uZUJvb2tJbXBvcnQuJGltcG9ydEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlcyB8fCBnbG9iYWxUcmFuc2xhdGUubW9kdWxlX3BobmJrX0dlbmVyYUxGaWxlVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59O1xuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgTW9kdWxlUGhvbmVCb29rSW1wb3J0LmluaXRpYWxpemUoKTtcbn0pOyJdfQ==